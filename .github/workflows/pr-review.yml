name: PR Review Agent

on:
  pull_request:
    types: [labeled, opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    # Only run when the ai_code_review label is present
    if: contains(github.event.pull_request.labels.*.name, 'ai_code_review')
    runs-on: ubuntu-latest

    # Define environment variables at job level to avoid redundancy
    env:
      BASE_REF: ${{ github.event.pull_request.base.ref }}
      HEAD_REF: ${{ github.event.pull_request.head.ref }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_AUTHOR: ${{ github.event.pull_request.user.login }}
      PR_DESCRIPTION: ${{ github.event.pull_request.body }}
      REPO_NAME: ${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin "$BASE_REF"

      - name: Generate diff
        id: diff
        run: |
          echo "Generating diff for PR #$PR_NUMBER"
          DIFF=$(git diff "origin/$BASE_REF...HEAD")
          DIFF_SIZE=$(echo "$DIFF" | wc -c)
          echo "Diff size: $DIFF_SIZE bytes"

          if [ "$DIFF_SIZE" -gt 600000 ]; then
            echo "error=Diff size ($DIFF_SIZE bytes) exceeds 600KB limit" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ -z "$DIFF" ]; then
            echo "error=No changes detected in this PR" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Save diff to file for the next step
          echo "$DIFF" > /tmp/pr-diff.txt
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run AI Code Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # Comma-separated list of models to try in order (fallback support)
          AI_MODELS: "minimax/minimax-m2:free,qwen/qwen3-coder:free,deepseek/deepseek-chat-v3.1:free,z-ai/glm-4.5-air:free"
          AI_TEMPERATURE: "0.2"
          AI_MAX_TOKENS: "8000"
          MAX_DIFF_SIZE: "600000"
          BASE_BRANCH: ${{ env.BASE_REF }}
          HEAD_BRANCH: ${{ env.HEAD_REF }}
        run: |
          cat /tmp/pr-diff.txt | bash .github/scripts/pr-review.sh

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå AI Code Review failed. Check the Actions log for details.'
            })
